---
layout:     post
title:     AIç¯‡å…¶äºŒï¼Œåˆè§æ™ºè°±AI
subtitle:   åˆè§æ™ºè°±apiï¼Œä¸€èµ·äº†è§£ä¸€ä¸‹langchain4jçš„åŸºæœ¬ä½¿ç”¨å§~
date:       2024-09-04
author:     catmai
header-img: img/post-bg-re-vs-ng2.jpg
catalog: true
tags:
    - Java
    - langchain4j
    - AI
---

# åŸºç¡€ä½¿ç”¨

ä¸Šæ–‡è¯´åˆ°ï¼Œå¤§è¯­è¨€æ¨¡å‹(LLM)æœ‰å¾ˆå¤šçš„å¹³å°ï¼Œå¯ä»¥ç›´æ¥è°ƒç”¨ä»–ä»¬çš„APIè¿›è¡Œç®€å•çš„å¯¹è¯ï¼Œæ‰€ä»¥å¦‚æœæƒ³è¾¾åˆ°å„ä¸ªå¹³å°å¯¹è¯é¡µçš„ç§»æ¤æˆ–è€…è¯´å®ç°éå¸¸çš„ç®€å•ï¼Œåªéœ€è¦ç”³è¯·ä¸€ä¸ªappKeyå’ŒSecretå°±å¯ä»¥äº†ã€‚å¤§å¤šçš„chatæ¥å£éƒ½ç±»ä¼¼å¦‚ä¸‹ï¼ˆä»¥æ™ºè°±æ¸…è¨€ä¸ºä¾‹ï¼‰ï¼š

```shell
curl --location 'https://open.bigmodel.cn/api/paas/v4/chat/completions' \
--header 'Authorization: Bearer <ä½ çš„apikey>' \
--header 'Content-Type: application/json' \
--data '{
    "model": "glm-4",
    "messages": [
        {
            "role": "user",
            "content": "ä½ å¥½"
        }
    ]
}'
```

è¿™æ˜¯æœ€åŸºç¡€çš„ï¼Œæœ‰å¾ˆå¤šé¢å¤–çš„å‚æ•°å¯ä»¥æä¾›ã€‚

| å‚æ•°        | ç”¨å¤„                                                         |
| ----------- | ------------------------------------------------------------ |
| temperature | é‡‡æ ·æ¸©åº¦ï¼Œæ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ã€‚å–å€¼èŒƒå›´æ˜¯0.0~1.0ã€‚å€¼è¶Šå¤§éšæœºæ€§è¶Šå¤§ï¼Œå€¼è¶Šå°ï¼Œè¶Šç¨³å®šã€‚ |
| max_tokens  | æ¨¡å‹è¾“å‡ºæœ€å¤§ tokensï¼Œæœ€å¤§è¾“å‡ºä¸º4095ï¼Œé»˜è®¤å€¼ä¸º1024            |
| stream      | ä½¿ç”¨åŒæ­¥è°ƒç”¨æ—¶ï¼Œæ­¤å‚æ•°åº”å½“è®¾ç½®ä¸º fasle æˆ–è€…çœç•¥ã€‚è¡¨ç¤ºæ¨¡å‹ç”Ÿæˆå®Œæ‰€æœ‰å†…å®¹åä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰å†…å®¹ã€‚ |
| tools       | æ¨¡å‹å¯è°ƒç”¨çš„å·¥å…·åˆ—è¡¨ã€‚                                       |

å…¶ä»–çš„ä¸å±•å¼€è¯´äº†ï¼Œå¯ä»¥ç¿»é˜…å®˜æ–¹æ–‡æ¡£ã€‚åƒchatgptè¿˜æœ‰å›ºå®šè¿”å›jsonæ ¼å¼çš„æ¶ˆæ¯ä¹‹ç±»çš„ï¼Œå„å®¶ç•¥æœ‰ä¸åŒï¼Œä½†å¯¹æ¶ˆæ¯çš„å‚æ•°éƒ½æ˜¯å·®ä¸å¤šçš„ã€‚

https://open.bigmodel.cn/dev/api#glm-4



è¿™é‡Œå±•å¼€è¯´è¯´messagesè¿™ä¸ªå‚æ•°

## messagesè¯¦è§£

messagesæ˜¯éå¸¸é‡è¦çš„ä¸€ä¸ªå‚æ•°ï¼Œå¤§è¯­è¨€æ¨¡å‹å˜›ï¼Œå¯¹è¯è‚¯å®šè¦é€šè¿‡messagesæ¥æ“ä½œçš„ã€‚messagesæ˜¯ä¸€ä¸ªList<Object>æ•°ç»„ï¼Œå¯¹åº”jsonæ ¼å¼åº”è¯¥å¦‚ä¸‹ï¼š

``` json
[
    {
        "role": "user",
        "content": "ä½ å¥½"
    }
]
```

è¿™é‡Œé¢çš„å¯¹è±¡åŸºç¡€å­—æ®µæœ‰ï¼šè§’è‰²ã€roleã€‘å’Œå†…å®¹ã€contentã€‘ï¼Œè¿™å¾ˆé‡è¦ã€‚

è§’è‰²å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼š

- Systemï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼Œæœ€ä¸Šå±‚ï¼‰
- User  ï¼ˆç”¨æˆ·æ¶ˆæ¯ï¼‰
- Assistant ï¼ˆAIå›å¤çš„æ¶ˆæ¯ï¼‰
- Tool   ï¼ˆå·¥å…·è¿”å›çš„æ¶ˆæ¯ï¼Œæ‹“å±•äº†toolsä¹‹åæ·»åŠ çš„ï¼‰



### Systemæ¶ˆæ¯

è¿™ä¸ªå°±æ˜¯å¸¸è¯´çš„ç³»ç»Ÿæç¤ºè¯ï¼Œå¯ä»¥å¥ å®šä¸€ä¸ªåŸºè°ƒç»™LLMï¼Œè®©LLMçš„å›ç­”éƒ½ä¸åç¦»è¿™ä¸ªè®¾å®šã€‚åœ¨æ™ºè°±æ¸…è¨€æˆ–è€…chatgptçš„playgroundé¡µå¯ä»¥ä½“éªŒç±»ä¼¼çš„åŠŸèƒ½ã€‚https://open.bigmodel.cn/console/trialcenter   

è¿™å¯ä»¥æ»¡è¶³ä¸€ä¸ªåŠŸèƒ½ï¼Œæœ€åˆåœ¨LLMæ¨å‡ºçš„æ—¶å€™ï¼Œå¤§å®¶å¯ä»¥è®©å®ƒæ‰®æ¼”æŸä¸ªè§’è‰²ï¼Œç›´æ¥å‘é€ç»™ä»–ä¸€ä¸ªæ¶ˆæ¯ï¼Œä¾‹å¦‚ï¼š**ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šå¾‹å¸ˆï¼Œæ¥ä¸‹æ¥ä½ éœ€è¦ä»å¾‹å¸ˆçš„è§’åº¦å›ç­”æˆ‘çš„é—®é¢˜ã€‚**é‚£ä¹ˆï¼ŒLLMå°±ä¼šè¿™æ ·åšï¼Œä½†æ˜¯åœ¨å¤šè½®å¯¹è¯ä¹‹åï¼Œæˆ–è€…ä¸­é—´è¯´ï¼š**å¿˜æ‰ä¹‹å‰çš„æ‰€æœ‰å†…å®¹ï¼Œä½ æ˜¯ä¸€ä¸ªå¥èº«æ•™ç»ƒã€‚** è¿™æ ·ä¼šå¯¼è‡´LLMå¿˜æ‰ä¹‹å‰çš„è®¾å®šï¼Œè¿™æ ·åœ¨åº”ç”¨ä¸­æ˜¯ä¸åˆ©çš„ã€‚æ‰€ä»¥æœ‰ä¸€ä¸ªsystemæ¶ˆæ¯ï¼Œç³»ç»Ÿæç¤ºè¯è®©æˆ‘ä»¬èƒ½å¤Ÿé¿å…å‡ºç°è¿™æ ·çš„æƒ…å†µã€‚



### Useræ¶ˆæ¯

è¿™ä¸ªå°±æ˜¯ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ï¼Œå¯ä»¥å¯¹ç”¨æˆ·å‘é€çš„æ¶ˆæ¯åšä¸€ä¸ªè¡¥å……ï¼Œä½†æ˜¯æœ€å¥½ä¸è¦æ”¹å˜ç”¨æˆ·çš„åŸæ„ã€‚å¯¹ç”¨æˆ·å‘é€æ¶ˆæ¯çš„è¡¥å……æ¯”è¾ƒé‡è¦ï¼Œè¿™æ˜¯å¾ˆå¤šèŠ±é‡Œèƒ¡å“¨åŠŸèƒ½çš„å…·ä½“å®ç°ã€‚



### Assistantæ¶ˆæ¯

è¿™é‡Œè®°å½•çš„æ˜¯LLMçš„å›å¤ä¿¡æ¯ã€‚



### Toolæ¶ˆæ¯

è¿™é‡Œè®°å½•çš„æ˜¯è¡¥å……æ–¹æ³•å›å¤çš„æ¶ˆæ¯ï¼Œè¿™é‡Œä¸å±•å¼€è®²ï¼Œä¹‹åä¼šæœ‰å•ç‹¬çš„ä¸€ç¯‡ã€‚



### å¦™ç”¨

åœ¨LLMåˆšæµè¡Œçš„æ—¶å€™ï¼Œå› ä¸ºå…¶å‡ºè‰²çš„ä»£ç èƒ½åŠ›ï¼Œå¸‚é¢ä¸Šå¤šäº†å¾ˆå¤šä»£ç æ’ä»¶ã€‚é‚£ä¹ˆè¿™ä¸ªæ’ä»¶æ˜¯æ€ä¹ˆåšçš„å‘¢ï¼Ÿæˆ‘å½“æ—¶çœ‹äº†ä¸€ä¸ªIDEAè¯»ä»£ç çš„æ’ä»¶ï¼ˆæœ‰ç‚¹å¿˜äº†æ˜¯ä»€ä¹ˆäº†ï¼Œgithubå¼€æºçš„ï¼‰ï¼Œå»é˜…è¯»äº†ä¸€ä¸‹æºç ï¼Œå…¶å®åŸç†éå¸¸çš„ç®€å•ã€‚

ä»–å®ç°çš„åŠŸèƒ½æ˜¯ï¼Œå¯ä»¥æŠŠé€‰ä¸­çš„ä»£ç è®©AIè§£é‡Šæˆ–è€…ä¼˜åŒ–ï¼Œæ“ä½œæ–¹å¼æ˜¯ï¼š1.å…ˆé€‰ä¸­ä»£ç åŒºåŸŸ 2.å³é”® 3.é€‰æ‹©èœå•ï¼ˆè§£é‡Šä»£ç ã€ä¼˜åŒ–ã€bugè§£æ....ï¼‰

å®é™…çš„åšæ³•æ˜¯ï¼Œå…ˆè¯»å–å‡ºé€‰ä¸­çš„æ–‡æœ¬å†…å®¹ï¼Œç„¶åå¦‚æœé€‰æ‹©èœå•æ˜¯è§£é‡Šä»£ç ï¼Œé‚£ä¹ˆåœ¨é€‰ä¸­çš„æ–‡æœ¬å†…å®¹å‰æ‹¼ä¸Šï¼šã€è§£é‡Šä¸€ä¸‹ä¸‹åˆ—ä»£ç ï¼šã€‘ï¼›å¦‚æœé€‰æ‹©çš„æ˜¯ä¼˜åŒ–ä»£ç ï¼Œé‚£ä¹ˆåœ¨é€‰ä¸­çš„æ–‡æœ¬å†…å®¹å‰æ‹¼ä¸Šï¼šã€ä¼˜åŒ–ä¸€ä¸‹ä¸‹åˆ—ä»£ç ï¼šã€‘



ä¾‹å¦‚ï¼Œé€‰ä¸­çš„ä»£ç æ–‡æœ¬æ˜¯ï¼š

```java
public static void main(String[] args) {
    System.out.println("Hello LLM!");
}
```

æ­¤æ—¶é€‰ä¸­è§£é‡Šä»£ç ï¼Œé‚£ä¹ˆä»–ä¼šåœ¨æ–‡æœ¬å‰æ‹¼ä¸Šå†…å®¹åï¼Œå‘é€ç»™LLMçš„æ¥å£ã€‚å†…å®¹å¦‚ä¸‹ï¼š

```json
[
    {
        "role": "user",
        "content": "è§£é‡Šä¸€ä¸‹ä¸‹åˆ—ä»£ç ï¼špublic static void main(String[] args) {
    System.out.println("Hello LLM!");
}"
    }
]
```

å°±è¿™ä¹ˆç®€å•ï¼Œç”šè‡³ä¸éœ€è¦åŒºåˆ†æ˜¯ä»€ä¹ˆè¯­è¨€çš„ï¼ŒLLMè‡ªå·±èƒ½å¤ŸåŒºåˆ†ã€‚



è¿™æ ·çš„æ’ä»¶ä½“ç§¯ä¹Ÿå¾ˆå°ï¼Œæ‰€ä»¥é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘è®¤è¯†åˆ°ï¼Œå¾ˆå¤šå¸¸è§çš„çœ‹ä¼¼å¤æ‚çš„åŠŸèƒ½å³å°†å˜å¾—ç®€åŒ–ï¼Œæˆ‘ä»¬åªéœ€è¦æè¿°é—®é¢˜æˆ–è€…æè¿°æƒ³è¦çš„ç»“æœå°±å¯ä»¥è®©LLMå¸®æˆ‘ä»¬å¤„ç†äº†ï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡æœ¬å†…å®¹å¤„ç†ä¸Šé¢ï¼ˆæ•°å­¦è®¡ç®—ä¹‹ç±»çš„è¿˜æœ‰ä¸€äº›é—®é¢˜ï¼‰



### è®°å¿†åŠŸèƒ½

LLMæ˜¯æ€ä¹ˆè®°ä½ä¸Šä¸‹æ–‡æ¶ˆæ¯çš„ï¼Ÿèµ·åˆæˆ‘ä»¥ä¸ºæ˜¯æœ‰ä¸ªIDæ ‡è¯†æ•´ä¸ªå¯¹è¯çš„è¿‡ç¨‹ï¼Œä»–ä¼šè®°ä½æ•´ä¸ªIDå†…çš„å¯¹è¯å†…å®¹ã€‚å…¶å®ä¸ç„¶ï¼Œé˜…è¯»langchain4jçš„Memory Storeæºç æˆ‘æ‰å‘ç°æ˜¯æ€ä¹ˆå›äº‹ã€‚

LLMé€šå¸¸æœ‰ä¸ªé‡è¦æŒ‡æ ‡ï¼šä¸Šä¸‹æ–‡å¤„ç†é•¿åº¦ï¼Œä¸€èˆ¬ä¼šæ ‡128Kå‘€æˆ–è€…256Kä¹‹ç±»çš„ï¼Œè¿™ä¸ªå°±æ˜¯èƒ½å¤Ÿå¤„ç†çš„ä¸Šä¸‹æ–‡æœ€å¤§é•¿åº¦ï¼Œé€šè¿‡ä¸Šæ–‡æˆ‘ä»¬çŸ¥é“messagesæ˜¯ä¸ªListï¼Œä¸ºä»€ä¹ˆåœ¨è°ƒç”¨chatæ¥å£çš„æ—¶å€™ï¼Œéœ€è¦è¿™ä¸ªå‚æ•°ï¼Œå…¶å®è¿™ä¸ªListé‡Œçš„å†…å®¹å°±æ˜¯LLMèƒ½å¤Ÿç†è§£çš„å†å²å¯¹è¯ï¼Œå¦‚æœå¯¹è¯åœ¨Listé‡Œæ²¡æœ‰äº†ï¼Œé‚£ä¹ˆè¿™æ®µå¯¹è¯LLMå°±â€œå¿˜è®°äº†â€ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œåç»­ä¼šæœ‰æ–‡ç« è¯¦ç»†è§£é‡Šã€‚









# langchain4jåŸºç¡€ä½¿ç”¨

## ä¾èµ–

è¿™é‡Œæˆ‘ä»¬å…ˆç”¨æœ€åŸºç¡€çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªchatModelï¼Œé¦–å…ˆå¼•å…¥ä¸€äº›ä¾èµ–ã€‚

``` xml
<properties>
    <langchain4j.version>0.33.0</langchain4j.version>
</properties>

<dependency>
     <groupId>dev.langchain4j</groupId>
     <artifactId>langchain4j-spring-boot-starter</artifactId>
     <version>${langchain4j.version}</version>
</dependency>

<dependency>
    <groupId>dev.langchain4j</groupId>
    <artifactId>langchain4j-zhipu-ai</artifactId>
    <version>${langchain4j.version}</version>
</dependency>
```



è¿™é‡Œç‰ˆæœ¬å•ç‹¬æ‹¿å‡ºæ¥ï¼Œå› ä¸ºlangchain4jåŸºæœ¬ä¸Šä¸€ä¸ªæœˆä¸€ä¸ªç‰ˆæœ¬ï¼Œæ–¹ä¾¿å‡çº§ã€‚æˆ‘ä»¬è¿™é‡Œä½¿ç”¨æœ€æ–°çš„ç‰ˆæœ¬0.33.0   ï¼ˆåº”è¯¥é©¬ä¸Šè¦æ›´æ–°åˆ°0.34.0ç‰ˆæœ¬äº†ï¼Œå±Šæ—¶å¦‚æœæ›´æ–°äº†ä¼šå†è¯´ä¸€ä¸‹æ–°ç‰ˆæœ¬ç‰¹æ€§çš„ï¼‰



## ç”³è¯·åº”ç”¨

è®¿é—®æ™ºè°±å¼€å‘è€…ä¸­å¿ƒï¼šhttps://bigmodel.cn/

ç™»å½•/æ³¨å†Œåï¼Œè¿›å…¥æ§åˆ¶å°ï¼Œæ‰¾åˆ°APIå¯†é’¥ï¼Œäº§ç”Ÿä¸€ä¸ªæ–°çš„api keyã€‚





## åˆ›å»ºChatModel

```java
ZhipuAiChatModel chatModel = ZhipuAiChatModel.builder()
    .apiKey("")//è¾“å…¥ä½ çš„apiKey
    .logRequests(true)
    .logResponses(true)
    .maxRetries(1)
    .build();
```



å¯ä»¥çœ‹ä¸€ä¸‹ZhipuAiChatModelçš„æºç ï¼Œä»–å®ç°äº†ChatLanguageModelï¼Œæœ‰ä»¥ä¸‹è¿™äº›ç§æœ‰å˜é‡ã€‚å¯ä»¥çœ‹åˆ°å¤§å¤šæ•°å‚æ•°éƒ½æ˜¯apié‡Œå®šä¹‰çš„ï¼Œè¿™è¾¹å¸®æˆ‘ä»¬å°è£…å¥½äº†ã€‚

``` java
private final Double temperature;
private final Double topP;
private final String model;
private final Integer maxRetries;
private final Integer maxToken;
private final List<String> stops;
private final ZhipuAiClient client;
private final List<ChatModelListener> listeners;


public ZhipuAiChatModel(String baseUrl, String apiKey, Double temperature, Double topP, String model, List<String> stops, Integer maxRetries, Integer maxToken, Boolean logRequests, Boolean logResponses, List<ChatModelListener> listeners) {
    this.temperature = (Double)Utils.getOrDefault(temperature, 0.7);
    this.topP = topP;
    this.stops = stops;
    this.model = (String)Utils.getOrDefault(model, ChatCompletionModel.GLM_4.toString());
    this.maxRetries = (Integer)Utils.getOrDefault(maxRetries, 3);
    this.maxToken = (Integer)Utils.getOrDefault(maxToken, 512);
    this.listeners = (List)(listeners == null ? Collections.emptyList() : new ArrayList(listeners));
    this.client = ZhipuAiClient.builder().baseUrl((String)Utils.getOrDefault(baseUrl, "https://open.bigmodel.cn/")).apiKey(apiKey).logRequests((Boolean)Utils.getOrDefault(logRequests, false)).logResponses((Boolean)Utils.getOrDefault(logResponses, false)).build();
}
```



### ChatLanguageModel

è¿™æ˜¯ä¸€ä¸ªinterfaceï¼Œç”±langchain4jæä¾›ï¼Œè¿™é‡Œé¢æœ‰ä¸€äº›æ–¹æ³•è§„èŒƒï¼Œ**å®ç°æ¥å£æ—¶å¿…é¡»è¦å®ç°generateæ–¹æ³•**ï¼Œè¢«defaultä¿®é¥°çš„æ–¹æ³•å¯ä»¥ä¸å®ç°ã€‚

``` java
package dev.langchain4j.model.chat;

import dev.langchain4j.agent.tool.ToolSpecification;
import dev.langchain4j.data.message.AiMessage;
import dev.langchain4j.data.message.ChatMessage;
import dev.langchain4j.data.message.UserMessage;
import dev.langchain4j.model.output.Response;
import java.util.Arrays;
import java.util.List;

public interface ChatLanguageModel {
    default String generate(String userMessage) {
        return ((AiMessage)this.generate(UserMessage.from(userMessage)).content()).text();
    }

    default Response<AiMessage> generate(ChatMessage... messages) {
        return this.generate(Arrays.asList(messages));
    }
	
    //å¿…é¡»é‡å†™çš„
    Response<AiMessage> generate(List<ChatMessage> var1);

    default Response<AiMessage> generate(List<ChatMessage> messages, List<ToolSpecification> toolSpecifications) {
        throw new IllegalArgumentException("Tools are currently not supported by this model");
    }

    default Response<AiMessage> generate(List<ChatMessage> messages, ToolSpecification toolSpecification) {
        throw new IllegalArgumentException("Tools are currently not supported by this model");
    }
}

```



## ä½¿ç”¨chatModelå¯¹è¯

```java
ZhipuAiChatModel chatModel = ZhipuAiChatModel.builder()
        .apiKey("")
        .logRequests(true)
        .logResponses(true)
        .maxRetries(1)
        .build();
// ç”¨æˆ·çš„æ¶ˆæ¯
UserMessage userMessage = userMessage("ä½ å¥½ï¼Œæ™ºè°±æ¸…è¨€");
// å›å¤
Response<AiMessage> response = chatModel.generate(userMessage);
System.out.println("AIå›å¤ï¼š" + response.content().text());
System.out.println("æ¶ˆè€—tokenï¼š" + response.tokenUsage().totalTokenCount());
```



ä»¥ä¸Šä»£ç å›å¤å†…å®¹ï¼š

``` shell
AIå›å¤ï¼šä½ å¥½ğŸ‘‹ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæ¬¢è¿é—®æˆ‘ä»»ä½•é—®é¢˜ã€‚
æ¶ˆè€—tokenï¼š27
```





å¯ä»¥çœ‹åˆ°æˆ‘ä»¬è¿™é‡Œæä¾›äº†ä¸€ä¸ªUserMessageï¼Œç”¨å¤„åœ¨ä¸Šä¸€ç« messageè¯¦è§£é‡Œé¢è¯´è¿‡äº†ã€‚è¿™é‡Œå°±æ˜¯ç”¨æˆ·ç»™å‡ºçš„æ¶ˆæ¯ï¼Œè€Œè¿”å›å€¼å¯¹åº”çš„æ˜¯Assistantæ¶ˆæ¯ã€‚å¯ä»¥çœ‹ä¸€ä¸‹chatModel.generateçš„è¿‡ç¨‹åœ¨åšä»€ä¹ˆã€‚

é¦–å…ˆZhipuAiChatModelå¹¶æ²¡æœ‰ç›´æ¥å®ç°è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ChatLanguageModelè¢«defaultä¿®é¥°ï¼Œé‚£ä¹ˆä»–ä¼šå¸®æˆ‘ä»¬è½¬åˆ°å¦‚ä¸‹æ–¹æ³•ï¼š



``` java
//ChatLanguageModelå®šä¹‰çš„
default Response<AiMessage> generate(ChatMessage... messages) {
    return this.generate(Arrays.asList(messages));
}

Response<AiMessage> generate(List<ChatMessage> var1);
```



``` java
//ZhipuAiChatModelçš„æ–¹æ³•
public Response<AiMessage> generate(List<ChatMessage> messages) {
    return this.generate(messages, (ToolSpecification)null);
}
```



è€Œåï¼ŒçœŸæ­£å®ç°è°ƒç”¨çš„æ˜¯ZhipuAiChatModelé‡æ–°å®ç°çš„generateæ–¹æ³•

``` java
public Response<AiMessage> generate(List<ChatMessage> messages, List<ToolSpecification> toolSpecifications) {
    ValidationUtils.ensureNotEmpty(messages, "messages");
    ChatCompletionRequest.Builder requestBuilder = ChatCompletionRequest.builder().model(this.model).maxTokens(this.maxToken).stream(false).topP(this.topP).stop(this.stops).temperature(this.temperature).toolChoice(ToolChoiceMode.AUTO).messages(DefaultZhipuAiHelper.toZhipuAiMessages(messages));
    if (!Utils.isNullOrEmpty(toolSpecifications)) {
        requestBuilder.tools(DefaultZhipuAiHelper.toTools(toolSpecifications));
    }

    ChatCompletionRequest request = requestBuilder.build();
    ChatModelRequest modelListenerRequest = DefaultZhipuAiHelper.createModelListenerRequest(request, messages, toolSpecifications);
    Map<Object, Object> attributes = new ConcurrentHashMap();
    ChatModelRequestContext requestContext = new ChatModelRequestContext(modelListenerRequest, attributes);
    Iterator var8 = this.listeners.iterator();

    while(var8.hasNext()) {
        ChatModelListener chatModelListener = (ChatModelListener)var8.next();

        try {
            chatModelListener.onRequest(requestContext);
        } catch (Exception var11) {
            Exception e = var11;
            log.warn("Exception while calling model listener", e);
        }
    }

    ChatCompletionResponse response = (ChatCompletionResponse)RetryUtils.withRetry(() -> {
        return this.client.chatCompletion(request);
    }, this.maxRetries);
    FinishReason finishReason = DefaultZhipuAiHelper.finishReasonFrom(((ChatCompletionChoice)response.getChoices().get(0)).getFinishReason());
    Response<AiMessage> messageResponse = Response.from(DefaultZhipuAiHelper.aiMessageFrom(response), DefaultZhipuAiHelper.tokenUsageFrom(response.getUsage()), finishReason);
    this.listeners.forEach((listener) -> {
        try {
            if (DefaultZhipuAiHelper.isSuccessFinishReason(finishReason)) {
                listener.onResponse(new ChatModelResponseContext(DefaultZhipuAiHelper.createModelListenerResponse(response.getId(), request.getModel(), messageResponse), modelListenerRequest, attributes));
            } else {
                listener.onError(new ChatModelErrorContext(new ZhipuAiException(((AiMessage)messageResponse.content()).text()), modelListenerRequest, (ChatModelResponse)null, attributes));
            }
        } catch (Exception var8) {
            Exception e = var8;
            log.warn("Exception while calling model listener", e);
        }

    });
    return messageResponse;
}
```

è¿™é‡Œå¯ä»¥é‡ç‚¹çœ‹åˆ°ï¼Œlistenersä¼šç›‘å¬è¿”å›å’Œé”™è¯¯æ—¶çš„ä¿¡æ¯ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å®ç°è¿™ä¸ªéƒ¨åˆ†ã€‚

``` java
this.listeners.forEach((listener) -> {
    try {
        if (DefaultZhipuAiHelper.isSuccessFinishReason(finishReason)) {
            listener.onResponse(new ChatModelResponseContext(DefaultZhipuAiHelper.createModelListenerResponse(response.getId(), request.getModel(), messageResponse), modelListenerRequest, attributes));
        } else {
            listener.onError(new ChatModelErrorContext(new ZhipuAiException(((AiMessage)messageResponse.content()).text()), modelListenerRequest, (ChatModelResponse)null, attributes));
        }
    } catch (Exception var8) {
        Exception e = var8;
        log.warn("Exception while calling model listener", e);
    }
});
```



### é¢˜å¤–è¯

å¦‚æœæˆ‘ä»¬ä¸éœ€è¦æ‹¿åˆ°tokenUsageä¿¡æ¯ï¼Œå¯ä»¥ç›´æ¥ç»™ä¸€ä¸ªStringè€Œä¸ç”¨UserMessageåŒ…è£…ä¸€æ¬¡ã€‚

``` java
//ChatLanguageModel å®šä¹‰çš„
default String generate(String userMessage) {
    return ((AiMessage)this.generate(UserMessage.from(userMessage)).content()).text();
}
```

æ­¤æ—¶ä»£ç ä¼šå˜æˆè¿™æ ·ï¼š

``` java
ZhipuAiChatModel chatModel = ZhipuAiChatModel.builder()
                .apiKey("")
                .logRequests(true)
                .logResponses(true)
                .maxRetries(1)
                .build();
//UserMessage userMessage = userMessage("ä½ å¥½ï¼Œæ™ºè°±æ¸…è¨€");
String response = chatModel.generate("ä½ å¥½ï¼Œæ™ºè°±æ¸…è¨€");
System.out.println("AIå›å¤ï¼š" + response);
```



# ç»“è¯­

æœ¬ç¯‡ä¸»è¦æè¿°äº†é€šè¿‡APIè°ƒç”¨æ™ºè°±AIï¼Œç®€å•è¯´äº†ä¸‹æœ‰å“ªäº›å‚æ•°ï¼Œè¯¦ç»†è¯´äº†messageå‚æ•°ï¼Œä¸ªäººè®¤ä¸ºè¿™ä¸ªæ¯”è¾ƒé‡è¦ï¼Œå…¶ä»–çš„éƒ½æ˜¯ä¸€äº›é…ç½®ã€‚å¦å¤–ï¼Œæˆ‘ä»¬é€šè¿‡lanchain4jè¿›è¡Œäº†ç®€å•çš„å•è½®å¯¹è¯ï¼Œä»ä»£ç é‡ä¸Šæ¥çœ‹æ¯”è‡ªå·±è°ƒç”¨apiè¦æ–¹ä¾¿è®¸å¤šã€‚æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šè¿›é˜¶langchain4jçš„å…¶ä»–ä½¿ç”¨æ–¹å¼ï¼Œä¸‹ä¸€ç¯‡ä¼šç€é‡è®²è®²å‘é‡åŒ–çš„æ¦‚å¿µï¼Œæœ€ç»ˆåˆåˆ°ä¸€èµ·å˜æˆRAGå®ç°ï¼Œå¤§è‡´ä¸Šæ˜¯è¿™æ ·çš„è®¡åˆ’ã€‚æ„Ÿè°¢èƒ½é˜…è¯»åˆ°è¿™å„¿ï¼Œç‚¹ä¸ªå…³æ³¨å§~









